@model IEnumerable<ProductCategory.Models.Product>
@{
    ViewData["Title"] = "產品管理";
}

<div class="container-fluid">
    <!-- 頁面標題區域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 text-primary mb-0">
                        <i class="fas fa-box-open me-2"></i>產品管理
                    </h1>
                    <p class="text-muted mb-0">管理您的產品庫存和資訊</p>
                </div>
                <div>
                    <a asp-action="Create" class="btn btn-success btn-lg shadow-sm">
                        <i class="fas fa-plus me-2"></i>新增產品
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計卡片區域 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">總產品數</h6>
                            <h4 class="mb-0">@Model.Count()</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cubes fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">有庫存</h6>
                            <h4 class="mb-0">@Model.Count(p => p.UnitsInStock > 0)</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">庫存不足</h6>
                            <h4 class="mb-0">@Model.Count(p => p.UnitsInStock <= p.ReorderLevel)</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">已停產</h6>
                            <h4 class="mb-0">@Model.Count(p => p.Discontinued)</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-ban fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 產品表格區域 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>產品列表
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" id="productTable">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-tag me-1"></i>產品名稱</th>
                                    <th><i class="fas fa-truck me-1"></i>供應商ID</th>
                                    <th><i class="fas fa-box me-1"></i>包裝規格</th>
                                    <th><i class="fas fa-dollar-sign me-1"></i>單價</th>
                                    <th><i class="fas fa-warehouse me-1"></i>庫存量</th>
                                    <th><i class="fas fa-shopping-cart me-1"></i>訂購中</th>
                                    <th><i class="fas fa-level-down-alt me-1"></i>再訂購點</th>
                                    <th><i class="fas fa-power-off me-1"></i>狀態</th>
                                    <th><i class="fas fa-folder me-1"></i>類別</th>
                                    <th><i class="fas fa-cogs me-1"></i>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td><strong>@Html.DisplayFor(modelItem => item.ProductName)</strong></td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                @Html.DisplayFor(modelItem => item.SupplierId)
                                            </span>
                                        </td>
                                        <td>@Html.DisplayFor(modelItem => item.QuantityPerUnit)</td>
                                        <td>
                                            <span class="text-success fw-bold">
                                                $@Html.DisplayFor(modelItem => item.UnitPrice)
                                            </span>
                                        </td>
                                        <td>
                                            @* 這裡只顯示數字，方便搜尋與排序 *@
                                            @Html.DisplayFor(modelItem => item.UnitsInStock)
                                        </td>
                                        <td>@Html.DisplayFor(modelItem => item.UnitsOnOrder)</td>
                                        <td>
                                            <small class="text-muted">
                                                @Html.DisplayFor(modelItem => item.ReorderLevel)
                                            </small>
                                        </td>
                                        <td>
                                            @if (item.Discontinued)
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-ban me-1"></i>已停產
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>正常
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-info">
                                                @Html.DisplayFor(modelItem => item.Category.CategoryId)
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a asp-action="Details" asp-route-id="@item.ProductId"
                                                   class="btn btn-sm btn-outline-info" title="查看詳情">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-action="Edit" asp-route-id="@item.ProductId"
                                                   class="btn btn-sm btn-outline-warning" title="編輯">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a asp-action="Delete" asp-route-id="@item.ProductId"
                                                   class="btn btn-sm btn-outline-danger" title="刪除"
                                                   onclick="return confirm('確定要刪除這個產品嗎？')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    .display-6 {
        font-weight: 600;
    }

    .card {
        border: none;
        border-radius: 10px;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-group .btn {
        margin: 0 1px;
    }

    .opacity-75 {
        opacity: 0.75;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.02);
    }

    #productTable th:nth-child(3), #productTable th:nth-child(4), #productTable th:nth-child(5), #productTable th:nth-child(6),
    #productTable td:nth-child(3), #productTable td:nth-child(4), #productTable td:nth-child(5), #productTable td:nth-child(6) {
        text-align: right;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_info {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .dataTables_wrapper .dataTables_paginate {
        margin-top: 1rem;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }

    .dataTables_wrapper .dataTables_filter input {
        margin-left: 0.5rem;
    }

    .dt-buttons {
        margin-bottom: 1rem;
    }

    .dt-button {
        margin-right: 0.5rem;
    }

    @@media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }

            .btn-group .btn {
                margin: 1px 0;
            }
    }
</style>

<!-- jQuery 與 Bootstrap -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables Core + Bootstrap5 -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- Buttons plugins -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
    $(document).ready(function() {
        // ======== 自訂庫存狀態篩選器 ========
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var stockFilter = $('#stockStatusFilter').val();
                var unitsInStock = parseInt(data[4]) || 0; // 第5欄是庫存量
                var reorderLevel = parseInt(data[6]) || 0; // 第7欄是再訂購點

                if (!stockFilter || stockFilter === "") return true;
                if (stockFilter === "有庫存")    return unitsInStock > 0;
                if (stockFilter === "庫存不足")  return unitsInStock <= reorderLevel;
                if (stockFilter === "缺貨")      return unitsInStock === 0;
                return true;
            }
        );

        // ======== 自訂狀態排序 ========
        $.fn.dataTable.ext.type.order['status-sort-pre'] = function(data) {
            return data.includes('正常') ? 1 : 0;
        };
        $.fn.dataTable.ext.type.order['currency-pre'] = function(data) {
            var num = data.toString().replace(/[$,\s]/g, '');
            return parseFloat(num) || 0;
        };

        var table = $('#productTable').DataTable({
            "processing": true,
            "responsive": true,
            "autoWidth": false,
            "pageLength": 25,
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "全部"]],
            "order": [[0, "asc"]],
            "columnDefs": [
                { "targets": -1, "orderable": false, "searchable": false, "className": "text-center" },
                { "targets": [1, 7, 8], "className": "text-center" },
                { "targets": [3], "type": "currency", "orderable": true },
                { "targets": [4], "type": "num" },
                { "targets": [5], "type": "num" },
                { "targets": [6], "type": "num", "orderable": true },
                { "targets": [7], "type": "status-sort" }
            ],
            "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                   "<'row'<'col-sm-12 col-md-12'B>>" +
                   "<'row'<'col-sm-12'tr>>" +
                   "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            "buttons": [
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> 匯出 Excel',
                    className: 'btn btn-success btn-sm',
                    title: '產品清單_' + new Date().toISOString().slice(0,10)
                },
                {
                    extend: 'csv',
                    text: '<i class="fas fa-file-csv"></i> 匯出 CSV',
                    className: 'btn btn-info btn-sm',
                    title: '產品清單_' + new Date().toISOString().slice(0,10)
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> 列印',
                    className: 'btn btn-secondary btn-sm',
                    title: '產品清單'
                }
            ],
            "language": {
                "processing": "處理中...",
                "loadingRecords": "載入中...",
                "lengthMenu": "顯示 _MENU_ 筆記錄",
                "zeroRecords": "沒有找到符合的記錄",
                "info": "顯示第 _START_ 至 _END_ 筆記錄，共 _TOTAL_ 筆",
                "infoEmpty": "顯示第 0 至 0 筆記錄，共 0 筆",
                "infoFiltered": "(從 _MAX_ 筆記錄中過濾)",
                "search": "搜尋:",
                "paginate": {
                    "first": "第一頁",
                    "previous": "上一頁",
                    "next": "下一頁",
                    "last": "最後一頁"
                },
                "aria": {
                    "sortAscending": ": 升序排列",
                    "sortDescending": ": 降序排列"
                },
                "buttons": {
                    "copy": "複製",
                    "print": "列印",
                    "excel": "Excel",
                    "csv": "CSV"
                }
            },
            "initComplete": function() {
                addCustomFilters();
            }
        });

        // ======== 自訂下拉篩選元件 ========
        function addCustomFilters() {
            var stockFilter = $('<div class="col-md-3 mb-2">' +
                '<select class="form-select form-select-sm" id="stockStatusFilter">' +
                '<option value="">所有庫存狀態</option>' +
                '<option value="有庫存">有庫存</option>' +
                '<option value="庫存不足">庫存不足</option>' +
                '<option value="缺貨">缺貨</option>' +
                '</select>' +
                '</div>');
            var statusFilter = $('<div class="col-md-3 mb-2">' +
                '<select class="form-select form-select-sm" id="productStatusFilter">' +
                '<option value="">所有產品狀態</option>' +
                '<option value="正常">正常</option>' +
                '<option value="已停產">已停產</option>' +
                '</select>' +
                '</div>');
            var clearFilter = $('<div class="col-md-2 mb-2">' +
                '<button class="btn btn-outline-secondary btn-sm w-100" id="clearFilters">' +
                '<i class="fas fa-eraser me-1"></i>清除篩選' +
                '</button>' +
                '</div>');
            var filterRow = $('<div class="row mb-3"></div>');
            filterRow.append(stockFilter).append(statusFilter).append(clearFilter);
            $('#productTable_wrapper').prepend(filterRow);

            $('#stockStatusFilter').on('change', function() {
                table.draw(); // 觸發自訂過濾
            });
            $('#productStatusFilter').on('change', function() {
                table.column(7).search(this.value).draw(); // 直接 DataTables 內建搜尋
            });
            $('#clearFilters').on('click', function() {
                $('#stockStatusFilter').val('');
                $('#productStatusFilter').val('');
                table.search('').columns().search('').draw();
                table.draw();
            });
        }

        window.refreshTable = function() {
            table.ajax.reload();
        };
    });
</script>
